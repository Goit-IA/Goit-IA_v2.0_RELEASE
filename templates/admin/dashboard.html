{% extends "base.html" %}

{% block title %}Panel de Administraci√≥n{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">

<section class="container">
    
    <div class="dashboard-header">
        <h1>Panel de Control</h1>
        <a href="{{ url_for('admin.logout') }}" class="btn-secondary">Cerrar Sesi√≥n</a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div style="margin-bottom: 2rem;">
        {% for category, message in messages %}
         <div class="alert-box alert-{{ category }}">
             {{ message }}
          </div>
        {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="dashboard-panel">
        <h3 class="panel-title"> Estado de la IA</h3>
        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
            Si has subido, borrado o editado documentos, entrena el modelo para actualizar la IA.
        </p>
        <form action="{{ url_for('admin.train_model') }}" method="POST">
            <button type="submit" class="cta-button"> Entrenar Modelo Ahora</button>
        </form>
    </div>

    <div class="dashboard-grid">
        
        <div class="dashboard-panel" style="grid-column: 1 / -1;"> 
            <h3 class="panel-title"> Registro de Usuarios (Total)</h3>
            
            {% if stats and stats|length > 0 %}
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-top: 1rem;">
                    {% for programa, cantidad in stats.items() %}
                    <div style="background: var(--bg-color); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border-color); text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="font-size: 2.5rem; font-weight: 800; color: var(--primary-color); margin-bottom: 0.5rem;">{{ cantidad }}</div>
                        <div style="font-size: 0.85rem; color: var(--text-color); font-weight: 600;">{{ programa }}</div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div style="text-align: center; padding: 2rem; background: var(--bg-color); border-radius: 8px; border: 1px dashed var(--border-color);">
                    <p style="color: var(--text-secondary);">No hay registros de acceso a√∫n.</p>
                </div>
            {% endif %}

            <div style="margin-top: 1.5rem; text-align: right;">
                <button onclick="document.getElementById('logModal').style.display='flex'" class="btn-secondary" style="cursor: pointer; display: inline-flex; align-items: center; gap: 5px;">
                     Ver registro detallado
                </button>
            </div>
        </div>
        
        <div class="dashboard-panel">
            <h3 class="panel-title">Documentos PDF</h3>
            
            <form action="{{ url_for('admin.upload_pdf') }}" method="POST" enctype="multipart/form-data" class="admin-form">
                <input type="file" name="file" accept=".pdf" required class="admin-input">
                <button type="submit" class="cta-button btn-small">Subir</button>
            </form>
            
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Estado</th>
                            <th style="text-align: right;">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if pdfs %}
                            {% for pdf in pdfs %}
                            <tr>
                                <td title="{{ pdf.filename }}" style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    {{ pdf.filename }}
                                </td>
                                <td>
                                    {% if pdf.status == 'Activo' %} 
                                        <span class="status-active">‚óè Activo</span>
                                    {% else %} 
                                        <span class="status-pending">‚óè En espera</span>
                                    {% endif %}
                                </td>
                                <td style="text-align: right; white-space: nowrap;">
                                    <button type="button" class="btn-icon btn-edit" onclick="openPdfModal('{{ pdf.filename }}')" title="Renombrar">
                                        ‚úèÔ∏è
                                    </button>

                                    <form action="{{ url_for('admin.delete_pdf') }}" method="POST" onsubmit="return confirm('¬øSeguro que quieres eliminar este PDF?');" style="display:inline;">
                                        <input type="hidden" name="filename" value="{{ pdf.filename }}">
                                        <button type="submit" class="btn-icon btn-danger" title="Eliminar">üóëÔ∏è</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="3" style="text-align: center; padding: 1.5rem; color: var(--text-secondary);">Sin documentos.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="dashboard-panel">
            <h3 class="panel-title"> Enlaces Web</h3>
            
            <form action="{{ url_for('admin.add_url') }}" method="POST" class="admin-form" style="flex-direction: column;">
                <input type="text" name="name" placeholder="Nombre (ej. Becas)" required class="admin-input">
                <input type="url" name="url" placeholder="https://..." required class="admin-input">
                <button type="submit" class="cta-button btn-small" style="align-self: flex-start; margin-top:5px;">Agregar</button>
            </form>

            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Tema</th>
                            <th>Estado</th>
                            <th style="text-align: right;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if urls %}
                            {% for url in urls %}
                            <tr>
                                <td>
                                    <a href="{{ url.url }}" target="_blank" style="font-weight: 500;">{{ url.name }}</a>
                                </td>
                                <td>
                                    {% if url.status == 'Activo' %} 
                                        <span class="status-active">‚óè Activo</span>
                                    {% else %} 
                                        <span class="status-pending">‚óè En espera</span>
                                    {% endif %}
                                </td>
                                <td style="text-align: right; white-space: nowrap;">
                                    <button type="button" class="btn-icon btn-edit" onclick="openUrlModal('{{ url.name }}', '{{ url.url }}')" title="Editar">
                                        ‚úèÔ∏è
                                    </button>
                                    
                                    <form action="{{ url_for('admin.delete_url') }}" method="POST" onsubmit="return confirm('¬øEliminar enlace?');" style="display:inline;">
                                        <input type="hidden" name="url" value="{{ url.url }}">
                                        <button type="submit" class="btn-icon btn-danger" title="Eliminar">üóëÔ∏è</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="3" style="text-align: center; padding: 1.5rem; color: var(--text-secondary);">Sin enlaces.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>

<div id="logModal" class="modal-overlay" style="display: none;">
    <div class="modal-box" style="max-width: 900px; width: 95%; max-height: 85vh; display: flex; flex-direction: column;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="margin: 0; color: var(--primary-color);"> Registro de Accesos</h3>
            <button onclick="document.getElementById('logModal').style.display='none'" class="btn-icon" style="font-size: 1.5rem;">&times;</button>
        </div>

        <div class="table-container" style="overflow-y: auto; flex-grow: 1; border: 1px solid var(--border-color);">
            <table class="data-table">
                <thead>
                    <tr style="position: sticky; top: 0; background: var(--secondary-bg-color); z-index: 2;">
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Programa</th>
                        <th>IP</th>
                        <th>Dispositivo</th>
                    </tr>
                </thead>
                <tbody>
                    {% if access_logs %}
                        {% for log in access_logs %}
                        <tr>
                            <td style="white-space: nowrap;">{{ log.Fecha }}</td>
                            <td>{{ log.Hora }}</td>
                            <td style="font-weight: 500;">{{ log.Programa }}</td>
                            <td>{{ log.IP }}</td>
                            <td style="font-size: 0.8rem; color: var(--text-secondary);" title="{{ log.Dispositivo }}">
                                {{ log.Dispositivo[:30] }}...
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="5" style="text-align: center; padding: 2rem;">No hay datos registrados a√∫n.</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        <div style="margin-top: 1rem; text-align: right;">
            <button onclick="document.getElementById('logModal').style.display='none'" class="cta-button">Cerrar</button>
        </div>
    </div>
</div>

<div id="urlModal" class="modal-overlay" style="display: none;">
    <div class="modal-box">
        <h3>Editar Enlace</h3>
        <form action="{{ url_for('admin.edit_url') }}" method="POST">
            <input type="hidden" id="edit_url_original" name="original_url">
            
            <div style="margin-bottom: 1rem;">
                <label style="display:block; margin-bottom:5px;">Nombre</label>
                <input type="text" id="edit_url_name" name="name" required class="admin-input" style="width: 100%;">
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display:block; margin-bottom:5px;">URL</label>
                <input type="url" id="edit_url_value" name="url" required class="admin-input" style="width: 100%;">
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
                <button type="button" onclick="document.getElementById('urlModal').style.display='none'" class="btn-secondary">Cancelar</button>
                <button type="submit" class="cta-button">Guardar Cambios</button>
            </div>
        </form>
    </div>
</div>

<div id="pdfModal" class="modal-overlay" style="display: none;">
    <div class="modal-box">
        <h3>Renombrar Archivo PDF</h3>
        <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">
            Esto cambiar√° el nombre del archivo en el servidor. Tendr√°s que re-entrenar el modelo despu√©s.
        </p>
        <form action="{{ url_for('admin.edit_pdf') }}" method="POST">
            <input type="hidden" id="edit_pdf_original" name="original_filename">
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display:block; margin-bottom:5px;">Nuevo Nombre</label>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <input type="text" id="edit_pdf_new" name="new_filename" required class="admin-input" style="width: 100%;">
                    <span style="color: var(--text-secondary);">.pdf</span>
                </div>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
                <button type="button" onclick="document.getElementById('pdfModal').style.display='none'" class="btn-secondary">Cancelar</button>
                <button type="submit" class="cta-button">Renombrar</button>
            </div>
        </form>
    </div>
</div>

<script>
    // --- L√ìGICA JAVASCRIPT UNIFICADA ---

    // Abrir Modal URL
    function openUrlModal(name, url) {
        document.getElementById('edit_url_original').value = url;
        document.getElementById('edit_url_name').value = name;
        document.getElementById('edit_url_value').value = url;
        document.getElementById('urlModal').style.display = 'flex';
    }

    // Abrir Modal PDF
    function openPdfModal(filename) {
        document.getElementById('edit_pdf_original').value = filename;
        // Quitamos la extensi√≥n visualmente para que sea m√°s f√°cil editar
        const nameWithoutExt = filename.replace('.pdf', '');
        document.getElementById('edit_pdf_new').value = nameWithoutExt;
        document.getElementById('pdfModal').style.display = 'flex';
    }

    // Cerrar al hacer clic fuera (Cualquier modal)
    window.onclick = function(event) {
        const modals = ['logModal', 'urlModal', 'pdfModal'];
        modals.forEach(id => {
            const modal = document.getElementById(id);
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        });
    }
</script>
{% endblock %}